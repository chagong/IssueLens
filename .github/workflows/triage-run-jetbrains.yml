name: Triage Issues For JetBrains Copilot

on:
  schedule:
    - cron: '0 0 * * 1-5'  # Runs every weekday at 08:00 Shanghai Time (UTC+8)
  workflow_dispatch:
    inputs:
      user_query:
        description: 'Custom user query (leave empty for default triage query)'
        type: string
        required: false
        default: ''
      since_date:
        description: 'Triage issues opened since this date (YYYY-MM-DD)'
        type: string
        required: false
        default: '2026-01-01'

jobs:
  triage-jetbrains-copilot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot
      
      - name: Triage with Copilot CLI
        id: triage
        run: |
          # Define default user query
          since_date="${{ inputs.since_date || '2026-01-01' }}"
          default_query="Triage open issues that were opened since ${since_date}"
          
          # Use custom query if provided, otherwise use default
          if [ -n "${{ inputs.user_query }}" ]; then
            user_query="${{ inputs.user_query }}"
          else
            user_query="$default_query"
          fi

          # Define target repositories
          repos="- microsoft/copilot-intellij-feedback"

          # Define instructions and notes
          read -r -d '' instructions << 'INSTRUCTIONS' || true
          ## Important: Context Management Strategy
          There may be a large number of issues to triage. To avoid losing context:

          ### Phase 1: Fetch and Triage Issues (batch processing)
          1. Fetch all matching open issues from each target repository.
          2. Process issues in batches (up to 30 at a time).
          3. For each issue, perform labeling and SLA check.
          4. After each batch, append the triage results to a local JSON file `triage-results.json` using the following schema:
             ```json
             [
               {
                 "repo": "owner/repo",
                 "issue_number": 123,
                 "title": "Issue title",
                 "url": "https://github.com/owner/repo/issues/123",
                 "assignees": ["user1", "user2"],
                 "labels": ["bug", "area:chat"],
                 "labels_added": ["bug"],
                 "sla_status": "GOOD | WARNING | VIOLATION",
                 "sla_details": "Brief reason",
                 "days_open": 5
               }
             ]
             ```
          5. Use `cat triage-results.json` to verify saved results before moving to the next batch.
          6. Repeat until all issues are processed.

          ### Phase 2: Group and Summarize (read from file)
          After ALL issues are processed:
          1. Read `triage-results.json` to get the full picture.
          2. Group SLA violations by assignee.
          3. Send personal notifications to assignees for SLA violations using the 'send-personal-notification' skill.
             - Retrieve assignee email addresses from the 'IDS' environment variable.
             - Group issues by assignee and send one notification per assignee.
             - If an issue has multiple assignees, notify each of them.
             - Skip notification if the assignee's email is not found.
          4. Send a summary email of the triage operation using the 'send-email' skill.
             - Send to email addresses specified in the 'REPORT_RECIPIENTS' environment variable.
             - Include counts: total issues triaged, SLA good, SLA warning, SLA violation.

          ### Skill Usage
          - Label issues using the 'label-issue' skill.
          - Check SLA compliance using the 'check-sla' skill.

          ## Notes
          - Use 'gh' CLI if you encounter issues with MCP tools.
          - Always persist intermediate results to `triage-results.json` so nothing is lost between batches.
          - Initialize `triage-results.json` with `echo '[]' > triage-results.json` before starting.
          - Use `jq` to merge batch results: `jq -s 'add' triage-results.json batch.json > tmp.json && mv tmp.json triage-results.json`
          INSTRUCTIONS

          # Define workflow URL
          workflow_url="Workflow Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Compose the full prompt
          prompt="$user_query

          ## Target Repositories
          $repos

          $instructions

          $workflow_url"

          echo "Triage with prompt: $prompt"
          output=$(copilot --allow-all --enable-all-github-mcp-tools --no-custom-instructions --no-ask-user --prompt "$prompt" 2>&1 || true)
          
          echo "Raw output:"
          echo "$output"
          
          # Save output to file for artifact
          echo "$output" > triage-output.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          IDS: ${{ secrets.IDS }}
          REPORT_RECIPIENTS: ${{ secrets.REPORT_RECIPIENTS }}
          MAILING_URL: ${{ secrets.MAILING_URL }}
          PERSONAL_NOTIFICATION_URL: ${{ secrets.PERSONAL_NOTIFICATION_URL }}

      - name: Upload triage output
        uses: actions/upload-artifact@v4
        with:
          name: triage-output
          path: triage-output.txt
          retention-days: 30
