name: Triage Issues For JetBrains Copilot

on:
  #schedule:
  #  - cron: '0 1 * * 1-5'  # Runs every weekday at 09:00 Shanghai Time (UTC+8)
  workflow_dispatch:
    inputs:
      user_query:
        description: 'Custom user query (leave empty for default triage query)'
        type: string
        required: false
        default: ''

jobs:
  triage-jetbrains-copilot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install GitHub Copilot CLI
        run: npm install -g @github/copilot
      
      - name: Mask sensitive variables
        run: |
          echo "::add-mask::${{ vars.IDS }}"
          echo "::add-mask::${{ vars.REPORT_RECIPIENTS }}"
      
      - name: Triage with Copilot CLI
        id: triage
        run: |
          # Calculate time scope: 72 hours if Monday, otherwise 24 hours
          if [ "$(date -u +%u)" -eq 1 ]; then
            since_date=$(date -u -d "72 hours ago" +'%Y-%m-%dT%H:00:00Z')
          else
            since_date=$(date -u -d "24 hours ago" +'%Y-%m-%dT%H:00:00Z')
          fi

          # Define default user query
          default_query="Triage open issues that were opened since $since_date"
          
          # Use custom query if provided, otherwise use default
          if [ -n "${{ inputs.user_query }}" ]; then
            user_query="${{ inputs.user_query }}"
          else
            user_query="$default_query"
          fi

          # Define target repositories
          repos="- microsoft/copilot-intellij-feedback"

          # Define instructions and notes
          read -r -d '' instructions << 'INSTRUCTIONS' || true
          ## Instructions
          1. Label issues using the 'label-issue' skill.
          2. Check SLA compliance using the 'check-sla' skill.
          3. Send personal notifications to assignees for SLA violations using the 'send-personal-notification' skill.
             - Retrieve assignee email addresses from the 'IDS' environment variable.
             - Group issues by assignee and send one notification per assignee.
             - If an issue has multiple assignees, notify each of them.
             - Skip notification if the assignee's email is not found.
          4. Send a summary email of the triage operation using the 'send-email' skill.
             - Send to email addresses specified in the 'REPORT_RECIPIENTS' environment variable.

          ## Notes
          - Use 'gh' CLI if you encounter issues with MCP tools.
          INSTRUCTIONS

          # Define workflow URL
          workflow_url="Workflow Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Compose the full prompt
          prompt="$user_query

          ## Target Repositories
          $repos

          $instructions

          $workflow_url"

          echo "Triage with prompt: $prompt"
          output=$(copilot --allow-all --enable-all-github-mcp-tools --no-custom-instructions --no-ask-user --prompt "$prompt" 2>&1 || true)
          
          echo "Raw output:"
          echo "$output"
          
          # Save output to file for artifact
          echo "$output" > triage-output.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          IDS: ${{ vars.IDS }}
          REPORT_RECIPIENTS: ${{ vars.REPORT_RECIPIENTS }}
          MAILING_URL: ${{ secrets.MAILING_URL }}
          PERSONAL_NOTIFICATION_URL: ${{ secrets.PERSONAL_NOTIFICATION_URL }}

      - name: Upload triage output
        uses: actions/upload-artifact@v4
        with:
          name: triage-output
          path: triage-output.txt
          retention-days: 30
